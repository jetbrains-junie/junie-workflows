name: junie

on:
  workflow_call:
    secrets:
      GCP_DOCKER_JUNIE_KEY:
        required: false
    inputs:
      fix_conflicts:
        description: "temporary params, not using in workflow"
        type: boolean
        required: false
      skip_workflow_file_validation:
        description: "temporary params, not using in workflow"
        type: boolean
        required: false
      workflow_params:
        description: "JSON string containing all workflow parameters"
        type: string
        required: true

jobs:
  run-junie:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Extract workflow params
        id: workflow-params
        uses: actions/github-script@v7
        env:
          INPUT_PARAMS: ${{ inputs.workflow_params }}
        with:
          script: |
            const params = JSON.parse(core.getInput('params'));
            // for now we always use this default params for idea, junie_plugin and junie_runner versions
            const defaultParams = {
              idea_version: '2024.3.5',
              junie_plugin_download_url: 'https://github.com/jetbrains-junie/artifacts/releases/download/99.1-cloud-eap/ej-cloud-eap-243.99.1.zip',
              junie_runner_download_url: 'https://github.com/jetbrains-junie/artifacts/releases/download/35.1/junie-runner-35.1.jar'
            }
            const finalParams = { ...defaultParams, ...params };
            Object.keys(finalParams).forEach((key) => {
                core.setOutput(key, finalParams[key]);
            });         

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.workflow-params.outputs.checkout_ref }}

      - name: Prepare container and run Junie
        if: always() && (hashFiles('.devcontainer/devcontainer.json') != '')
        uses: devcontainers/ci@v0.3
        timeout-minutes: 50
        env:
          PROJECT_STACK: ${{ steps.workflow-params.outputs.project_stack }}
          ISSUE_TITLE: ${{ steps.workflow-params.outputs.issue_title }}
          ISSUE_BODY: ${{ steps.workflow-params.outputs.issue_body }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IDEA_VERSION: ${{ steps.workflow-params.outputs.idea_version }}
          JUNIE_DOWNLOAD_URL: ${{ steps.workflow-params.outputs.junie_plugin_download_url }}
          MATTERHORN_DEBUG_LOG: true
        with:
          imageName: project-devcontainer
          push: never
          env: |          
            PROJECT_STACK
            ISSUE_TITLE
            ISSUE_BODY
            GITHUB_TOKEN
            MATTERHORN_DEBUG_LOG
            JUNIE_DOWNLOAD_URL
          runCmd: |
            # Check if JAVA_HOME is set
            if [ -z "$JAVA_HOME" ]; then
              echo "JAVA_HOME is not set."
              # Check if java is available in PATH
              if ! command -v java >/dev/null 2>&1; then
                echo "Java is not available in PATH. Proceeding with installation..."
                # Install OpenJDK 17 JRE
                sudo apt-get -qq update >/dev/null
                sudo apt-get -qq install -y openjdk-17-jre >/dev/null
                echo "OpenJDK 17 JRE installed successfully."
              else
                echo "Java is available in PATH. No need to install."
              fi
            else
              echo "JAVA_HOME is set to '$JAVA_HOME'. No need to install."
            fi

            echo "Downloading ej-runner"
            sudo wget -nv "${{ steps.workflow-params.outputs.junie_runner_download_url }}" -O junie-runner.jar

            echo "Running ej-runner"
            sudo -E java -jar junie-runner.jar
            

      - name: Extracting .idea and ej-logs
        if: always() && (hashFiles('.devcontainer/devcontainer.json') != '')
        run: |
          pwd
          docker ps
          docker cp "$(docker ps -q)":/workspaces/idea-logs ./idea-logs
          docker cp "$(docker ps -q)":/workspaces/.matterhorn ./.matterhorn
          sudo chown -R runner:runner ${{ github.workspace }} || true

      - name: Prepare 21 Java for non-container run
        uses: actions/setup-java@v4
        if: always() && (hashFiles('.devcontainer/devcontainer.json') == '')
        with:
          distribution: 'temurin' # Need to be synced with "Force setting..." command in the next step
          java-version: '17'

      - name: Run Junie without container
        if: always() && (hashFiles('.devcontainer/devcontainer.json') == '')
        timeout-minutes: 50
        env:
          PROJECT_STACK: ${{ steps.workflow-params.outputs.project_stack }}
          ISSUE_TITLE: ${{ steps.workflow-params.outputs.issue_title }}
          ISSUE_BODY: ${{ steps.workflow-params.outputs.issue_body }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IDEA_VERSION: ${{ steps.workflow-params.outputs.idea_version }}
          JUNIE_DOWNLOAD_URL: ${{ steps.workflow-params.outputs.junie_plugin_download_url }}
          MATTERHORN_DEBUG_LOG: true
        run: |
          echo "Downloading ej-runner"
          sudo wget -nv "${{ steps.workflow-params.outputs.junie_runner_download_url }}" -O junie-runner.jar

          # https://github.com/actions/setup-java/issues/701
          echo "Force setting java version for sudo subprocesses"
          sudo update-alternatives --set java /usr/lib/jvm/temurin-17-jdk-amd64/bin/java
          sudo update-alternatives --set javac /usr/lib/jvm/temurin-17-jdk-amd64/bin/javac
          sudo java --version
          
          echo "Running ej-runner"
          sudo -E java -jar junie-runner.jar
          
          echo "Copying logs to target dir..."
          sudo cp -r ../idea-logs .
          sudo cp -r ../.matterhorn .
          sudo chown -R runner:runner ./idea-logs
          sudo chown -R runner:runner ./.matterhorn
          sudo chown -R runner:runner ${{ github.workspace }} || true

      - name: Save junie result summary
        id: junie_summary
        continue-on-error: true
        run: |
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$(cat .matterhorn/*issue_md.*swe_patch* | jq -r '.content.output')" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT          
          echo "output is $GITHUB_OUTPUT"

      - name: Archive .matterhorn
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: matterhorn-logs
          path: .matterhorn
          include-hidden-files: 'true'
          retention-days: 3

      - name: Restore or remove .idea directory
        run: |
          sudo rm -rf idea-logs
          sudo rm -rf .matterhorn
          sudo rm -rf .output.txt
          sudo rm -rf junie-runner.jar

          if git ls-tree -d HEAD .idea | grep "\.idea" >/dev/null 2>&1; then
            echo "Restoring tracked '.idea' directory"
            git checkout -- .idea
            git clean -f -d .idea            
          else
            echo "Removing untracked '.idea' directory"
            sudo rm -rf .idea
          fi

      # Uncomment when we support auto resolve conflicts
      # - name: Reset git changes from junie
      #   if: always()
      #   run: |
      #      git reset origin/${{ steps.workflow-params.outputs.checkout_ref }}

      - name: Create Pull Request for new issue
        if: steps.workflow-params.outputs.run_type == 'new_issue'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ steps.workflow-params.outputs.app_token }}
          commit-message: "chore(junie): ${{ steps.workflow-params.outputs.issue_title }} \n changes from the task: #${{ steps.workflow-params.outputs.issue_id }}"
          title: "[Junie]: ${{ steps.workflow-params.outputs.issue_title }}"
          body: |
            ## üìå Hey! This PR was made for you with Junie, the coding agent by JetBrains **Early Access Preview**
            
            It's still learning, developing, and might make mistakes. Please make sure you review the changes before you accept them.
            We‚Äôd love your feedback ‚Äî join our Discord to share bugs, ideas: [here](https://jb.gg/junie/github).
                                                              
            - üîó **Issue:** #${{ steps.workflow-params.outputs.issue_id }}
            - üè∑ **Title:** ${{ steps.workflow-params.outputs.issue_title }}
            
            ### üìù Original Issue Description  
            ${{ steps.workflow-params.outputs.issue_body }}
            
            ### üìä Junie Summary
            ${{ steps.junie_summary.outputs.summary }}
          branch: junie-issue-${{ steps.workflow-params.outputs.issue_id }}
          base: ${{ steps.workflow-params.outputs.checkout_ref }}

      - name: Create Pull Request for resolve conflicts
        if: steps.workflow-params.outputs.run_type == 'resolve_conflicts'
        uses: peter-evans/create-pull-request@v5
        with:
         token: ${{ steps.workflow-params.outputs.app_token }}
         commit-message: "chore(junie): resolve conflicts for ${{ steps.workflow-params.outputs.checkout_ref }}"
         title: "[Junie]: resolve conflicts for ${{ steps.workflow-params.outputs.checkout_ref }}"
         body: |
           ## üìå PR Details
           ### üìä Junie Summary
           ${{ steps.junie_summary.outputs.summary }}
         branch: junie-resolve-${{ steps.workflow-params.outputs.checkout_ref }}
         base: ${{ steps.workflow-params.outputs.checkout_ref }}

      - name: Commit changes to PR branch
        if: steps.workflow-params.outputs.run_type == 'fix_all' || steps.workflow-params.outputs.run_type == 'fix_single'
        run: |
          git config --global user.name 'junie[bot]'
          git config --global user.email 'junie[bot]@users.noreply.github.com'
          git add .
          git commit -m "[${{ steps.workflow-params.outputs.issue_id }}]" -m "summary: ${{ steps.junie_summary.outputs.summary }}"
          git push origin HEAD:${{ steps.workflow-params.outputs.checkout_ref }}
